# Server-side tracing in LWR

-   [Server-side tracing in LWR](#server-side-tracing-in-lwr)
    -   [Overview](#overview)
    -   [Tracer interface](#tracer-interface)
        -   [Trace levels](#trace-levels)
        -   [Custom tracing example](#custom-tracing-example)
    -   [Distributed tracing](#distributed-tracing)

## Overview

LWR exposes tracing functionality to the application layer, enabling developers to create custom spans and integrate tracing directly into their application hooks (eg: route handlers, config hooks).

Application hooks can consume `@lwrjs/instrumentation` directly to trace with minimal configuration.

Custom spans will automatically be handled by the metric exporter provided by LWR. They will be written to a trace collector and logged to Splunk.

## Tracer interface

`@lwrjs/instrumentation` exposes a `Tracer` built on top of [OpenTelemetry](https://opentelemetry.io/) which defines and manages spans. These spans represent units of work and are tracked as part of a larger trace for the entire request lifecycle. See the LWR spans [here](./src/spans.ts).

```ts
interface TraceID {
    // tracing information for a span
    name: string;
    attributes?: Record<string, string | number | boolean>;
}

interface Tracer {
    trace<T>(id: TraceID, fn: () => T): T;
}
```

### Trace levels

`@lwrjs/instrumentation` differentiates between two levels of tracing:

-   _Default_: Captures essential spans that provide an overview of the request flow, suitable for tracking critical aspects of the request lifecycle. All custom spans are are set to the `default` level.
-   _Verbose_: Offers more granular trace data to identify potential performance issues or get deeper insights into specific parts of the request.

### Custom tracing example

The following example shows how a route handler can use the tracer to create a span for page metadata retrieval:

```ts
import { getTracer } from '@lwrjs/instrumentation';

export default async function (request: ViewRequest, context: HandlerContext): Promise<ViewResponse> {
    // Create a span for the metadata retrieval operation
    const metadata = getTracer().trace(
        {
            name: 'app.routeHandler.metadata',
            attributes: { url: request.url },
        },
        (span) => {
            // Perform the actual metadata retrieval
            const data = metadataService.getMetadata(request.url);
            // add more attributes to the span
            span.setAttributes({ size: data.size });
            return data;
        },
    );
    // Continue with other route handling logic...
}
```

Trace functions may be async:

```ts
import { getTracer } from '@lwrjs/instrumentation';

export default async function (request: ViewRequest, context: HandlerContext): Promise<ViewResponse> {
    const body = await getTracer().trace(
        {
            name: 'app.routeHandler.payload',
            attributes: { url: request.url },
        },
        async () => {
            const payload = await generatePayload(request.url);
            return payload.body;
        },
    );
}
```

## Distributed tracing

By default, LWR attaches [B3 headers for distributed tracing](https://github.com/openzipkin/b3-propagation) to base documents and any data requests executed during server-side rendering (SSR). To turn this feature off, set the `DISABLE_B3_TRACING` environment variable to "true".
